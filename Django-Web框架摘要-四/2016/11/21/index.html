<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/VEN/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/VEN/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="站点管理对于某一类网站， 管理界面 是基础设施中非常重要的一部分。 这是以网页和有限的可信任管理者为基础的界面，它可以让你添加，编辑和删除网站内容。 一些常见的例子： 你可以用这个界面发布博客，后台的网站管理者用它来润色读者提交的内容，你的客户用你给他们建立的界面工具更新新闻并发布在网站上，这些都是使用管理界面的例子。
django.contrib包管理工具是本书讲述django.contrib的">
<meta property="og:type" content="article">
<meta property="og:title" content="Django-Web框架摘要(四)">
<meta property="og:url" content="http://yoursite.com/Django-Web框架摘要-四/2016/11/21/index.html">
<meta property="og:site_name" content="A Little Boy">
<meta property="og:description" content="站点管理对于某一类网站， 管理界面 是基础设施中非常重要的一部分。 这是以网页和有限的可信任管理者为基础的界面，它可以让你添加，编辑和删除网站内容。 一些常见的例子： 你可以用这个界面发布博客，后台的网站管理者用它来润色读者提交的内容，你的客户用你给他们建立的界面工具更新新闻并发布在网站上，这些都是使用管理界面的例子。
django.contrib包管理工具是本书讲述django.contrib的">
<meta property="og:image" content="https://i.gyazo.com/173fc607b3cf5b81507e81b0f7e69fc9.png">
<meta property="og:image" content="https://i.gyazo.com/84efb691ea98375efb7673559b069507.png">
<meta property="og:updated_time" content="2017-01-01T14:08:11.007Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Django-Web框架摘要(四)">
<meta name="twitter:description" content="站点管理对于某一类网站， 管理界面 是基础设施中非常重要的一部分。 这是以网页和有限的可信任管理者为基础的界面，它可以让你添加，编辑和删除网站内容。 一些常见的例子： 你可以用这个界面发布博客，后台的网站管理者用它来润色读者提交的内容，你的客户用你给他们建立的界面工具更新新闻并发布在网站上，这些都是使用管理界面的例子。
django.contrib包管理工具是本书讲述django.contrib的">
<meta name="twitter:image" content="https://i.gyazo.com/173fc607b3cf5b81507e81b0f7e69fc9.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/Django-Web框架摘要-四/2016/11/21/"/>


  <title> Django-Web框架摘要(四) | A Little Boy </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="default">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">A Little Boy</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">人生苦短</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      
        
        <li class="menu-item menu-item-comments">
          <a href="/comments" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            comments
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Django-Web框架摘要(四)
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-11-21T16:22:43+08:00" content="2016-11-21">
              2016-11-21
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/Django-Web框架摘要-四/2016/11/21/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="Django-Web框架摘要-四/2016/11/21/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/Django-Web框架摘要-四/2016/11/21/" class="leancloud_visitors" data-flag-title="Django-Web框架摘要(四)">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="站点管理"><a href="#站点管理" class="headerlink" title="站点管理"></a>站点管理</h3><p>对于某一类网站， 管理界面 是基础设施中非常重要的一部分。 这是以网页和有限的可信任管理者为基础的界面，它可以让你添加，编辑和删除网站内容。 一些常见的例子： 你可以用这个界面发布博客，后台的网站管理者用它来润色读者提交的内容，你的客户用你给他们建立的界面工具更新新闻并发布在网站上，这些都是使用管理界面的例子。</p>
<h4 id="django-contrib包"><a href="#django-contrib包" class="headerlink" title="django.contrib包"></a>django.contrib包</h4><p>管理工具是本书讲述django.contrib的第一个部分。从技术层面上讲，它被称作django.contrib.admin。django.contrib中其它可用的特性，如用户鉴别系统(django.contrib.auth)、支持匿名会话(django.contrib.sessioins)以及用户评注系统(django.contrib.comments)。这些，我们将在第十六章详细讨论。在成为一个Django专家以前，你将会知道更多django.contrib的特性。 目前，你只需要知道Django自带很多优秀的附加组件，它们都存在于django.contrib包里。</p>
<h4 id="激活管理界面"><a href="#激活管理界面" class="headerlink" title="激活管理界面"></a>激活管理界面</h4><p>第一步，对你的settings文件做如下这些改变：</p>
<ol>
<li>将’django.contrib.admin’加入setting的INSTALLED_APPS配置中 （INSTALLED_APPS中的配置顺序是没有关系的, 但是我们喜欢保持一定顺序以方便人来阅读）</li>
<li>保证INSTALLED_APPS中包含’django.contrib.auth’，’django.contrib.contenttypes’和’django.contrib.sessions’，Django的管理工具需要这3个包。 (如果你跟随本文制作mysite项目的话，那么请注意我们在第五章的时候把这三项INSTALLED_APPS条目注释了。现在，请把注释取消。)</li>
<li>确保MIDDLEWARE_CLASSES 包含’django.middleware.common.CommonMiddleware’ 、’django.contrib.sessions.middleware.SessionMiddleware’ 和’django.contrib.auth.middleware.AuthenticationMiddleware’ 。(再次提醒，如果有跟着做mysite的话，请把在第五章做的注释取消。)</li>
</ol>
<p>运行 <strong>python manage.py syncdb</strong> 。这一步将生成管理界面使用的额外数据库表。 </p>
<p>当你把’django.contrib.auth’加进INSTALLED_APPS后，第一次运行syncdb命令时, 系统会请你创建一个超级用户。 如果你不这么作，你需要运行python manage.py createsuperuser来另外创建一个admin的用户帐号，否则你将不能登入admin (提醒一句: 只有当INSTALLED_APPS包含’django.contrib.auth’时，python manage.py createsuperuser这个命令才可用.)</p>
<p>第三，将admin访问配置在URLconf(记住，在urls.py中). 默认情况下，命令django-admin.py startproject生成的文件urls.py是将Django admin的路径注释掉的，你所要做的就是取消注释。 请注意，以下内容是必须确保存在的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Include these import statements...</span></div><div class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</div><div class="line">admin.autodiscover()</div><div class="line"></div><div class="line"><span class="comment"># And include this URLpattern...</span></div><div class="line">urlpatterns = patterns(<span class="string">''</span>,</div><div class="line">    <span class="comment"># ...</span></div><div class="line">    (<span class="string">r'^admin/'</span>, include(admin.site.urls)),</div><div class="line">    <span class="comment"># ...</span></div><div class="line">)</div></pre></td></tr></table></figure></p>
<h4 id="Models加到Admin管理中"><a href="#Models加到Admin管理中" class="headerlink" title="Models加到Admin管理中"></a>Models加到Admin管理中</h4><p>在<code>books</code> 目录下(<code>mysite/books</code> )，创建一个文件：<code>admin.py</code> ，然后输入以下代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</div><div class="line"><span class="keyword">from</span> mysite.books.models <span class="keyword">import</span> Publisher, Author, Book</div><div class="line"></div><div class="line">admin.site.register(Publisher)</div><div class="line">admin.site.register(Author)</div><div class="line">admin.site.register(Book)</div></pre></td></tr></table></figure></p>
<p>这些代码通知管理工具为这些模块逐一提供界面。</p>
<h3 id="Admin工作原理"><a href="#Admin工作原理" class="headerlink" title="Admin工作原理"></a>Admin工作原理</h3><p>当服务启动时，Django从<code>url.py</code> 引导URLconf，然后执行<code>admin.autodiscover()</code> 语句。 这个函数遍历INSTALLED_APPS配置，并且寻找相关的 admin.py文件。 如果在指定的app目录下找到admin.py，它就执行其中的代码。</p>
<p>在<code>books</code> 应用程序目录下的<code>admin.py</code> 文件中，每次调用<code>admin.site.register()</code> 都将那个模块注册到管理工具中。 管理工具只为那些明确注册了的模块显示一个编辑/修改的界面。</p>
<p>应用程序<code>django.contrib.auth</code> 包含自身的<code>admin.py</code> ，所以Users和Groups能在管理工具中自动显示。 其它的django.contrib应用程序，如django.contrib.redirects，其它从网上下在的第三方Django应用程序一样，都会自行添加到管理工具。2</p>
<p>综上所述，管理工具其实就是一个Django应用程序，包含自己的模块、模板、视图和URLpatterns。 你要像添加自己的视图一样，把它添加到URLconf里面。 你可以在Django基本代码中的django/contrib/admin 目录下，检查它的模板、视图和URLpatterns，但你不要尝试直接修改其中的任何代码，因为里面有很多地方可以让你自定义管理工具的工作方式。 （如果你确实想浏览Django管理工具的代码，请谨记它在读取关于模块的元数据过程中做了些不简单的工作，因此最好花些时间阅读和理解那些代码。）</p>
<h4 id="字段设置"><a href="#字段设置" class="headerlink" title="字段设置"></a>字段设置</h4><p>设置字段可选：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span><span class="params">(models.Model)</span>:</span></div><div class="line">    first_name = models.CharField(max_length=<span class="number">30</span>)</div><div class="line">    last_name = models.CharField(max_length=<span class="number">40</span>)</div><div class="line">    email = models.EmailField(**blank=<span class="keyword">True</span>** )</div></pre></td></tr></table></figure></p>
<p>这些代码告诉Django，作者的邮箱地址允许输入一个空值。 所有字段都默认blank=False，这使得它们不允许输入空值。</p>
<p>如果你想允许一个日期型（DateField、TimeField、DateTimeField）或数字型（IntegerField、DecimalField、FloatField）字段为空，你需要使用null=True <em> 和</em> blank=True。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span><span class="params">(models.Model)</span>:</span></div><div class="line">    title = models.CharField(max_length=<span class="number">100</span>)</div><div class="line">    authors = models.ManyToManyField(Author)</div><div class="line">    publisher = models.ForeignKey(Publisher)</div><div class="line">    publication_date = models.DateField(**blank=<span class="keyword">True</span>, null=<span class="keyword">True</span>** )</div></pre></td></tr></table></figure></p>
<p>添加null=True比添加blank=True复杂。因为null=True改变了数据的语义，即改变了CREATE TABLE语句，把publication_date字段上的NOT NULL删除了。 要完成这些改动，我们还需要更新数据库。3</p>
<p>出于某种原因，Django不会尝试自动更新数据库结构。所以你必须执行ALTER TABLE语句将模块的改动更新至数据库。 像先前那样，你可以使用manage.py dbshell进入数据库服务环境。 以下是在这个特殊情况下如何删除NOT NULL:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ALTER TABLE books_book ALTER COLUMN publication_date DROP NOT NULL;</div></pre></td></tr></table></figure></p>
<p>（注意：以下SQL语法是PostgreSQL特有的。）</p>
<p><strong>自定义标签</strong><br>举个例子，说明如何将Author.email的标签改为e-mail，中间有个横线。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span><span class="params">(models.Model)</span>:</span></div><div class="line">    first_name = models.CharField(max_length=<span class="number">30</span>)</div><div class="line">    last_name = models.CharField(max_length=<span class="number">40</span>)</div><div class="line">    email = models.EmailField(blank=<span class="keyword">True</span>, **verbose_name=<span class="string">'e-mail'</span>** )</div></pre></td></tr></table></figure></p>
<p>修改后重启服务器，你会在author编辑页面中看到这个新标签。</p>
<p>请注意，你不必把verbose_name的首字母大写，除非是连续大写（如：”USA state”）。Django会自动适时将首字母大写，并且在其它不需要大写的地方使用verbose_name的精确值。5</p>
<p>最后还需注意的是，为了使语法简洁，你可以把它当作固定位置的参数传递。 这个例子与上面那个的效果相同。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span><span class="params">(models.Model)</span>:</span></div><div class="line">    first_name = models.CharField(max_length=<span class="number">30</span>)</div><div class="line">    last_name = models.CharField(max_length=<span class="number">40</span>)</div><div class="line">    email = models.EmailField(**<span class="string">'e-mail'</span>,**  blank=<span class="keyword">True</span>)</div></pre></td></tr></table></figure></p>
<p>但这不适用于ManyToManyField 和ForeignKey字段，因为它们第一个参数必须是模块类。 那种情形，必须显式使用verbose_name这个参数名称。</p>
<h3 id="自定义ModelAdmi类（data列表操作）"><a href="#自定义ModelAdmi类（data列表操作）" class="headerlink" title="自定义ModelAdmi类（data列表操作）"></a>自定义ModelAdmi类（data列表操作）</h3><p>迄今为止，我们做的blank=True、null=True和verbose_name修改其实是模块级别，而不是管理级别的。 也就是说，这些修改实质上是构成模块的一部分，并且正好被管理工具使用，而不是专门针对管理工具的。</p>
<p>除了这些，Django还提供了大量选项让你针对特别的模块自定义管理工具。 这些选项都在ModelAdmin classes里面，这些类包含了管理工具中针对特别模块的配置。</p>
<h4 id="自定义列表"><a href="#自定义列表" class="headerlink" title="自定义列表"></a>自定义列表</h4><p>我们可以在这基础上改进，添加其它字段，从而改变列表的显示。 这个页面应该提供便利，比如说：在这个列表中可以看到作者的邮箱地址。如果能按照姓氏或名字来排序，那就更好了。</p>
<p>为了达到这个目的，我们将为Author模块定义一个ModelAdmin类。 这个类是自定义管理工具的关键，其中最基本的一件事情是允许你指定列表中的字段。 打开admin.py并修改：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</div><div class="line"><span class="keyword">from</span> mysite.books.models <span class="keyword">import</span> Publisher, Author, Book</div><div class="line"></div><div class="line">**<span class="class"><span class="keyword">class</span> <span class="title">AuthorAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span>**</div><div class="line">    **list_display = (<span class="string">'first_name'</span>, <span class="string">'last_name'</span>, <span class="string">'email'</span>)**</div><div class="line"></div><div class="line">admin.site.register(Publisher)</div><div class="line">**admin.site.register(Author, AuthorAdmin)**</div><div class="line">admin.site.register(Book)</div></pre></td></tr></table></figure></p>
<p>解释一下代码：</p>
<blockquote><br>我们新建了一个类AuthorAdmin，它是从django.contrib.admin.ModelAdmin派生出来的子类，保存着一个类的自定义配置，以供管理工具使用。 我们只自定义了一项：list_display， 它是一个字段名称的元组，用于列表显示。 当然，这些字段名称必须是模块中有的。<br><br>我们修改了admin.site.register()调用，在Author后面添加了AuthorAdmin。你可以这样理解： 用AuthorAdmin选项注册Author模块。<br><br>admin.site.register()函数接受一个ModelAdmin子类作为第二个参数。 如果你忽略第二个参数，Django将使用默认的选项。Publisher和Book的注册就属于这种情况。<br></blockquote><br>弄好了这个东东，再刷新author列表页面，你会看到列表中有三列：姓氏、名字和邮箱地址。 另外，点击每个列的列头可以对那列进行排序。 接下来，<br><br>让我们添加一个快速查询栏。 向AuthorAdmin追加search_fields，如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></div><div class="line">    list_display = (<span class="string">'first_name'</span>, <span class="string">'last_name'</span>, <span class="string">'email'</span>)</div><div class="line">    **search_fields = (<span class="string">'first_name'</span>, <span class="string">'last_name'</span>)**</div></pre></td></tr></table></figure><br><br>刷新浏览器，你会在页面顶端看到一个查询栏。正如用户所希望的那样，它是大小写敏感，并且对两个字段检索的查询框。<br><br>接下来，让我们为Book列表页添加一些过滤器。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</div><div class="line"><span class="keyword">from</span> mysite.books.models <span class="keyword">import</span> Publisher, Author, Book</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></div><div class="line">    list_display = (<span class="string">'first_name'</span>, <span class="string">'last_name'</span>, <span class="string">'email'</span>)</div><div class="line">    search_fields = (<span class="string">'first_name'</span>, <span class="string">'last_name'</span>)</div><div class="line"></div><div class="line">**<span class="class"><span class="keyword">class</span> <span class="title">BookAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span>**</div><div class="line">    **list_display = (<span class="string">'title'</span>, <span class="string">'publisher'</span>, <span class="string">'publication_date'</span>)**</div><div class="line">    **list_filter = (<span class="string">'publication_date'</span>,)**</div><div class="line"></div><div class="line">admin.site.register(Publisher)</div><div class="line">admin.site.register(Author, AuthorAdmin)</div><div class="line">**admin.site.register(Book, BookAdmin)**</div></pre></td></tr></table></figure><br><br>由于我们要处理一系列选项，因此我们创建了一个单独的ModelAdmin类：BookAdmin。首先，我们定义一个list_display，以使得页面好看些。 然后，我们用list_filter这个字段元组创建过滤器，它位于列表页面的右边。 Django为日期型字段提供了快捷过滤方式，它包含：今天、过往七天、当月和今年。<br><br>另外一种过滤日期的方式是使用date_hierarchy选项<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></div><div class="line">    list_display = (<span class="string">'title'</span>, <span class="string">'publisher'</span>, <span class="string">'publication_date'</span>)</div><div class="line">    list_filter = (<span class="string">'publication_date'</span>,)</div><div class="line">    **date_hierarchy = <span class="string">'publication_date'</span>**</div></pre></td></tr></table></figure><br><br>修改好后，页面中的列表顶端会有一个逐层深入的导航条<br><br>最后，让我们改变默认的排序方式，按publication date降序排列。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></div><div class="line">    list_display = (<span class="string">'title'</span>, <span class="string">'publisher'</span>, <span class="string">'publication_date'</span>)</div><div class="line">    list_filter = (<span class="string">'publication_date'</span>,)</div><div class="line">    date_hierarchy = <span class="string">'publication_date'</span></div><div class="line">    **ordering = (<span class="string">'-publication_date'</span>,)**</div></pre></td></tr></table></figure><br><br>这个ordering选项基本像模块中class Meta的ordering那样工作，除了它只用列表中的第一个字段名。 如果要实现降序，仅需在传入的列表或元组的字段前加上一个减号(-)。<br><br><h4>自定义编辑表单</h4><br><br>首先，我们先自定义字段顺序。 默认地，表单中的字段顺序是与模块中定义是一致的。 我们可以通过使用ModelAdmin子类中的fields选项来改变它：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></div><div class="line">    list_display = (<span class="string">'title'</span>, <span class="string">'publisher'</span>, <span class="string">'publication_date'</span>)</div><div class="line">    list_filter = (<span class="string">'publication_date'</span>,)</div><div class="line">    date_hierarchy = <span class="string">'publication_date'</span></div><div class="line">    ordering = (<span class="string">'-publication_date'</span>,)</div><div class="line">    **fields = (<span class="string">'title'</span>, <span class="string">'authors'</span>, <span class="string">'publisher'</span>, <span class="string">'publication_date'</span>)**</div></pre></td></tr></table></figure><br><br>完成之后，编辑表单将按照指定的顺序显示各字段。 它看起来自然多了——作者排在书名之后。 字段顺序当然是与数据条目录入顺序有关， 每个表单都不一样。<br><br>当你的admi用户只是被信任可以更改你的某一部分数据时，或者，你的数据被一些外部的程序自动处理而改变了了，你就可以用这个功能。 例如，在book数据库中，我们可以隐藏publication_date（不写到fields上），以防止它被编辑。<br><br>当一个用户用这个不包含完整信息的表单添加一本新书时，<strong>Django会简单地将publication_date设置为None</strong>，以确保这个字段满足null=True的条件。<br><br>另一个常用的编辑页面自定义是针对多对多字段的。 真如我们在book编辑页面看到的那样，<code>多对多字段</code> 被展现成多选框。虽然多选框在逻辑上是最适合的HTML控件，但它却不那么好用。 如果你想选择多项，你必须还要按下Ctrl键（苹果机是command键）。 更好的办法是使用filter_horizontal：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></div><div class="line">    list_display = (<span class="string">'title'</span>, <span class="string">'publisher'</span>, <span class="string">'publication_date'</span>)</div><div class="line">    list_filter = (<span class="string">'publication_date'</span>,)</div><div class="line">    date_hierarchy = <span class="string">'publication_date'</span></div><div class="line">    ordering = (<span class="string">'-publication_date'</span>,)</div><div class="line">    **filter_horizontal = (<span class="string">'authors'</span>,)**</div></pre></td></tr></table></figure><br><br>（如果你一着跟着做练习，请注意移除fields选项，以使得编辑页面包含所有字段。）<br><br><strong>我们强烈建议针对那些拥有十个以上选项的<code>多对多字段</code> 使用filter_horizontal。 这比多选框好用多了。 你可以在多个字段上使用filter_horizontal，只需在这个元组中指定每个字段的名字。</strong><br><br>ModelAdmin类还支持filter_vertical选项。 它像filter_horizontal那样工作，除了控件都是垂直排列，而不是水平排列的。 至于使用哪个，只是个人喜好问题。<br><br>filter_horizontal和filter_vertical选项只能用在多对多字段 上, 而不能用于 ForeignKey字段。 默认地，管理工具使用<code>下拉框</code> 来展现<code>外键</code> 字段。但是，正如<code>多对多字段</code> 那样，有时候你不想忍受因装载并显示这些选项而产生的大量开销。解决这个问题的办法是使用<code>raw_id_fields</code> 选项。它是一个包含外键字段名称的元组，它包含的字段将被展现成<code>文本框</code> ，而不再是<code>下拉框</code>:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></div><div class="line">    list_display = (<span class="string">'title'</span>, <span class="string">'publisher'</span>, <span class="string">'publication_date'</span>)</div><div class="line">    list_filter = (<span class="string">'publication_date'</span>,)</div><div class="line">    date_hierarchy = <span class="string">'publication_date'</span></div><div class="line">    ordering = (<span class="string">'-publication_date'</span>,)</div><div class="line">    filter_horizontal = (<span class="string">'authors'</span>,)</div><div class="line">    **raw_id_fields = (<span class="string">'publisher'</span>,)**</div></pre></td></tr></table></figure><br><br>在这个输入框中，你输入什么呢？ publisher的数据库ID号。 考虑到人们通常不会记住这些数据库ID，管理工具提供了一个放大镜图标方便你输入。点击那个图标将会弹出一个窗口，在那里你可以选择想要添加的publishe。<br><br><br><h3>用户权限及管理界面</h3><br><br>因为你是用超级用户登录的，你可以创建，编辑和删除任何对像。 然而，不同的环境要求有不同的权限，系统不允许所有人都是超级用户。 管理工具有一个用户权限系统，通过它你可以根据用户的需要来指定他们的权限，从而达到部分访问系统的目的。<br><br>用户帐号应该是通用的、独立于管理界面以外仍可以使用。<br><br>当你创建一个用户时，它没有任何权限，该有什么权限是由你决定的。 例如，你可以给一个用户添加和修改publishers的权限，而不给他删除的权限。 请注意，这些权限是定义在模块级别上，而不是对象级别上的。据个例子，你可以让小强修改任何图书，但是不能让他仅修改由机械工业出版社出版的图书。 后面这种基于对象级别的权限设置比较复杂，并且超出了本书的覆盖范围，但你可以在Django documentation中寻找答案。<br><br>赋予一个用户修改用户的权限，本质上说就是把他变成一个超级用户。<br><br>何时、为什么使用管理界面？何时又不使用呢？<br><br>Django的管理界面对非技术用户要输入他们的数据时特别有用；事实上这个特性就是专门为这个 实现的。 在Django最开始开发的新闻报道的行业应用中，有一个典型的在线自来水的水质专题报道 应用，它的实现流程是这样的：<br><br>- 负责这个报道的记者和要处理数据的开发者碰头，提供一些数据给开发者。<br>- 开发者围绕这些数据设计模型然后配置一个管理界面给记者。<br>- 记者检查管理界面，尽早指出缺少或多余的字段。 开发者来回地修改模块。<br>- 当模块认可后，记者就开始用管理界面输入数据。 同时，程序员可以专注于开发公众访问视图和模板（有趣的部分）。<br><br><br>换句话说，Django的管理界面为内容输入人员和编程人员都提供了便利的工具。<br><br>当然，除了数据输入方面，我们发现管理界面在下面这些情景中也是很有用的：<br><br>- 检查模块：当你定义好了若干个模块，在管理页面中把他们调出来然后输入一些虚假的数据，这是相当有用的。 有时候，它能显示数据建模的错误或者模块中其它问题。<br>- 管理既得数据：如果你的应用程序依赖外部数据（来自用户输入或网络爬虫），管理界面提供了一个便捷的途径，让你检查和编辑那些数据。 你可以把它看作是一个功能不那么强大，但是很方便的数据库命令行工具。<br>- 临时的数据管理程序：你可以用管理工具建立自己的轻量级数据管理程序，比如说开销记录。 如果你正在根据自己的，而不是公众的需要开发些什么，那么管理界面可以带给你很大的帮助。 从这个意义上讲，你可以把它看作是一个增强的关系型电子表格。<br><br><br>最后一点要澄清的是： 管理界面不是终结者。 过往许多年间，我们看到它被拆分、修改成若干个功能模块，而这些功能不是它所支持的。 它不应成为一个<strong>公众</strong> 数据访问接口，也不应允许对你的数据进行复杂的排序和查询。 正如本章开头所说，它仅提供给可信任的管理员。 请记住这一点，它是有效使用管理界面的钥匙。<br><br><h3>表单view.py</h3><br><br>我们在第三章讲述View的函数时已经介绍过HttpRequest对象了，但当时并没有讲太多。 让我们回忆下：每个view函数的第一个参数是一个HttpRequest对象，就像下面这个hello()函数:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">return</span> HttpRespon(<span class="string">'Hello world'</span>)</div></pre></td></tr></table></figure><br><br>HttpRequest对象，比如上面代码里的request变量，会有一些有趣的、你必须让自己熟悉的属性和方法，以便知道能拿它们来做些什么。 在view函数的执行过程中，你可以用这些属性来获取当前request的一些信息（比如，你正在加载这个页面的用户是谁，或者用的是什么浏览器）。<br><br><h4>URL相关信息</h4><br><br>HttpRequest对象包含当前请求URL的一些信息：<br><img src="https://i.gyazo.com/173fc607b3cf5b81507e81b0f7e69fc9.png" alt=""><br>在view函数里，要始终用这个属性或方法来得到URL，而不要手动输入。 这会使得代码更加灵活，以便在其它地方重用。 下面是一个简单的例子：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># BAD!</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">current_url_view_bad</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"Welcome to the page at /current/"</span>)</div><div class="line"></div><div class="line"><span class="comment"># GOOD</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">current_url_view_good</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"Welcome to the page at %s"</span> % request.path)</div></pre></td></tr></table></figure><br><br><h4>request其他信息</h4><br><br>request.META 是一个Python字典，包含了所有本次HTTP请求的Header信息，比如用户IP地址和用户Agent（通常是浏览器的名称和版本号）。 注意，Header信息的完整列表取决于用户所发送的Header信息和服务器端设置的Header信息。 这个字典中几个常见的键值有：<br>- HTTP_REFERER，进站前链接网页，如果有的话。 （请注意，它是REFERRER的笔误。）<br>- HTTP_USER_AGENT，用户浏览器的user-agent字符串，如果有的话。 例如： “Mozilla/5.0 (X11; U; Linux i686; fr-FR; rv:1.8.1.17) Gecko/20080829 Firefox/2.0.0.17” .<br>- REMOTE_ADDR 客户端IP，如：”12.345.67.89” 。(如果申请是经过代理服务器的话，那么它可能是以逗号分割的多个IP地址，如：”12.345.67.89,23.456.78.90” 。)<br><br><br><br>注意，因为 request.META 是一个普通的Python字典，因此当你试图访问一个不存在的键时，会触发一个KeyError异常。 （HTTP header信息是由用户的浏览器所提交的、不应该给予信任的“额外”数据，因此你总是应该好好设计你的应用以便当一个特定的Header数据不存在时，给出一个优雅的回应。）你应该用 try/except 语句，或者用Python字典的 get() 方法来处理这些“可能不存在的键”。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># BAD!</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ua_display_bad</span><span class="params">(request)</span>:</span></div><div class="line">    ua = request.META[<span class="string">'HTTP_USER_AGENT'</span>]  <span class="comment"># Might raise KeyError!</span></div><div class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"Your browser is %s"</span> % ua)</div><div class="line"></div><div class="line"><span class="comment"># GOOD (VERSION 1)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ua_display_good1</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        ua = request.META[<span class="string">'HTTP_USER_AGENT'</span>]</div><div class="line">    <span class="keyword">except</span> KeyError:</div><div class="line">        ua = <span class="string">'unknown'</span></div><div class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"Your browser is %s"</span> % ua)</div><div class="line"></div><div class="line"><span class="comment"># GOOD (VERSION 2)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ua_display_good2</span><span class="params">(request)</span>:</span></div><div class="line">    ua = request.META.get(<span class="string">'HTTP_USER_AGENT'</span>, <span class="string">'unknown'</span>)</div><div class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"Your browser is %s"</span> % ua)</div></pre></td></tr></table></figure><br><br>我们鼓励你动手写一个简单的view函数来显示 request.META 的所有数据，这样你就知道里面有什么了。 这个view函数可能是这样的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_meta</span><span class="params">(request)</span>:</span></div><div class="line">    values = request.META.items()</div><div class="line">    values.sort()</div><div class="line">    html = []</div><div class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> values:</div><div class="line">        html.append(<span class="string">'&lt;tr&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;'</span> % (k, v))</div><div class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'&lt;table&gt;%s&lt;/table&gt;'</span> % <span class="string">'\n'</span>.join(html))</div></pre></td></tr></table></figure><br><br>除了基本的元数据，HttpRequest对象还有两个属性包含了用户所提交的信息： request.GET 和 request.POST。二者都是类字典对象，你可以通过它们来访问GET和POST数据。<br><br>POST数据是来自HTML中的〈form〉标签提交的，而GET数据可能来自〈form〉提交也可能是URL中的查询字符串(the query string)。<br><br><h4>resquest.POST和resquest.GET</h4><br><br>POST数据是来自HTML中的〈form〉标签提交的，而GET数据可能来自〈form〉提交也可能是URL中的查询字符串(the query string)。<br><br>继续本书一直进行的关于书籍、作者、出版社的例子，我们现在来创建一个简单的view函数以便让用户可以通过书名从数据库中查找书籍。<br><br>通常，表单开发分为两个部分： 前端HTML页面用户接口和后台view函数对所提交数据的处理过程。 第一部分很简单；现在我们来建立个view来显示一个搜索表单：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render_to_response</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_form</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'search_form.html'</span>)</div></pre></td></tr></table></figure><br><br>这个 search_form.html 模板，可能看起来是这样的：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;title&gt;Search&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;form action="/search/" method="get"&gt;</div><div class="line">        &lt;input type="text" name="q"&gt;</div><div class="line">        &lt;input type="submit" value="Search"&gt;</div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure><br><br>而 urls.py 中的 URLpattern 可能是这样的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> mysite.books <span class="keyword">import</span> views</div><div class="line"></div><div class="line">urlpatterns = patterns(<span class="string">''</span>,</div><div class="line">    <span class="comment"># ...</span></div><div class="line">    (<span class="string">r'^search-form/$'</span>, views.search_form),</div><div class="line">    <span class="comment"># ...</span></div><div class="line">)</div></pre></td></tr></table></figure><br><br>当你通过这个form提交数据时，你会得到一个Django 404错误。 这个Form指向的URL /search/ 还没有被实现。 让我们添加第二个视图函数并设置URL：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># urls.py</span></div><div class="line"></div><div class="line">urlpatterns = patterns(<span class="string">''</span>,</div><div class="line">    <span class="comment"># ...</span></div><div class="line">    (<span class="string">r'^search-form/$'</span>, views.search_form),</div><div class="line">    (<span class="string">r'^search/$'</span>, views.search),</div><div class="line">    <span class="comment"># ...</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment"># views.py</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="string">'q'</span> <span class="keyword">in</span> request.GET:</div><div class="line">        message = <span class="string">'You searched for: %r'</span> % request.GET[<span class="string">'q'</span>]</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        message = <span class="string">'You submitted an empty form.'</span></div><div class="line">    <span class="keyword">return</span> HttpResponse(message)</div></pre></td></tr></table></figure><br><br>暂时先只显示用户搜索的字词，以确定搜索数据被正确地提交给了Django，这样你就会知道搜索数据是如何在这个系统中传递的。 简而言之：<br>1. 在HTML里我们定义了一个变量q。当提交表单时，变量q的值通过GET(method=”get”)附加在URL /search/上。<br>2. 处理/search/（search()）的视图通过request.GET来获取q的值。<br><br>需要注意的是在这里明确地判断q是否包含在request.GET中。就像上面request.META小节里面提到，对于用户提交过来的数据，甚至是正确的数据，都需要进行过滤。 在这里若没有进行检测，那么用户提交一个空的表单将引发KeyError异常。<br><br>获取使用POST方法的数据与GET的相似，只是使用request.POST代替了request.GET。那么，POST与GET之间有什么不同？当我们提交表单仅仅需要获取数据时就可以用GET； 而当我们提交表单时需要更改服务器数据的状态，或者说发送e-mail，或者其他不仅仅是获取并显示数据的时候就使用POST。 在这个搜索书籍的例子里，我们使用GET，因为这个查询不会更改服务器数据的状态。 (如果你有兴趣了解更多关于GET和POST的知识，可以参见<a href="http://www.w3.org/2001/tag/doc/whenToUseGet.html" target="_blank" rel="external">http://www.w3.org/2001/tag/doc/whenToUseGet.html</a>。)<br><br>既然已经确认用户所提交的数据是有效的，那么接下来就可以从数据库中查询这个有效的数据（同样，在views.py里操作）<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</div><div class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render_to_response</div><div class="line"><span class="keyword">from</span> mysite.books.models <span class="keyword">import</span> Book</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="string">'q'</span> <span class="keyword">in</span> request.GET <span class="keyword">and</span> request.GET[<span class="string">'q'</span>]:</div><div class="line">        q = request.GET[<span class="string">'q'</span>]</div><div class="line">        books = Book.objects.filter(title__icontains=q)</div><div class="line">        <span class="keyword">return</span> render_to_response(<span class="string">'search_results.html'</span>,</div><div class="line">            &#123;<span class="string">'books'</span>: books, <span class="string">'query'</span>: q&#125;)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'Please submit a search term.'</span>)</div></pre></td></tr></table></figure><br><br>让我们来分析一下上面的代码：<br><blockquote><br>除了检查q是否存在于request.GET之外，我们还检查来reuqest.GET[‘q’]的值是否为空。<br><br>我们使用Book.objects.filter(title__icontains=q)获取数据库中标题包含q的书籍。 icontains是一个查询关键字（参看第五章和附录B）。这个语句可以理解为获取标题里包含q的书籍，不区分大小写。<br><br>这是实现书籍查询的一个很简单的方法。 我们不推荐在一个包含大量产品的数据库中使用icontains查询，因为那会很慢。 （在真实的案例中，我们可以使用以某种分类的自定义查询系统。 在网上搜索“开源 全文搜索”看看是否有好的方法）<br><br>最后，我们给模板传递来books，一个包含Book对象的列表。 查询结果的显示模板search_results.html如下所示：<br></blockquote>

<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>You searched for: <span class="tag">&lt;<span class="name">strong</span>&gt;</span>&#123;&#123; query &#125;&#125;<span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"></div><div class="line">&#123;/% if books %/&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Found &#123;&#123; books|length &#125;&#125; book&#123;&#123; books|pluralize &#125;&#125;.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">        &#123;/% for book in books %/&#125;</div><div class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123; book.title &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">        &#123;/% endfor %/&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">&#123;/% else %/&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>No books matched your search criteria.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">&#123;/% endif %/&#125;</div></pre></td></tr></table></figure>
<p>注意这里pluralize的使用，这个过滤器在适当的时候会输出s（例如找到多本书籍）。</p>
<h4 id="改进表单"><a href="#改进表单" class="headerlink" title="改进表单"></a>改进表单</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</div><div class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render_to_response</div><div class="line"><span class="keyword">from</span> mysite.books.models <span class="keyword">import</span> Book</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_form</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'search_form.html'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(request)</span>:</span></div><div class="line">    error = <span class="keyword">False</span></div><div class="line">    <span class="keyword">if</span> <span class="string">'q'</span> <span class="keyword">in</span> request.GET:</div><div class="line">        q = request.GET[<span class="string">'q'</span>]</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> q:</div><div class="line">            error = <span class="keyword">True</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            books = Book.objects.filter(title__icontains=q)</div><div class="line">            <span class="keyword">return</span> render_to_response(<span class="string">'search_results.html'</span>,</div><div class="line">                &#123;<span class="string">'books'</span>: books, <span class="string">'query'</span>: q&#125;)</div><div class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'search_form.html'</span>,</div><div class="line">        &#123;<span class="string">'error'</span>: error&#125;)</div></pre></td></tr></table></figure>
<p>这段代码里，我们改进来search()视图：在字符串为空时重新显示search_form.html。 并且给这个模板传递了一个变量error，记录着错误提示信息。 现在我们编辑一下search_form.html，检测变量error：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;title&gt;Search&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    **&#123;/% if error %/&#125;**</div><div class="line">        **&lt;p style=&quot;color: red;&quot;&gt;Please submit a search term.&lt;/p&gt;**</div><div class="line">    **&#123;/% endif %/&#125;**</div><div class="line">    &lt;form action=&quot;/search/&quot; method=&quot;get&quot;&gt;</div><div class="line">        &lt;input type=&quot;text&quot; name=&quot;q&quot;&gt;</div><div class="line">        &lt;input type=&quot;submit&quot; value=&quot;Search&quot;&gt;</div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>我们来调整一下search()视图，让她能够验证搜索关键词是否小于或等于20个字符。 （为来让例子更为显著，我们假设如果关键词超过20个字符将导致查询十分缓慢）。那么该如何实现呢？ 最简单的方式就是将逻辑处理直接嵌入到视图里，就像这样：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(request)</span>:</span></div><div class="line">    error = <span class="keyword">False</span></div><div class="line">    <span class="keyword">if</span> <span class="string">'q'</span> <span class="keyword">in</span> request.GET:</div><div class="line">        q = request.GET[<span class="string">'q'</span>]</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> q:</div><div class="line">            error = <span class="keyword">True</span></div><div class="line">        **<span class="keyword">elif</span> len(q) &gt; <span class="number">20</span>:**</div><div class="line">            **error = <span class="keyword">True</span>**</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            books = Book.objects.filter(title__icontains=q)</div><div class="line">            <span class="keyword">return</span> render_to_response(<span class="string">'search_results.html'</span>,</div><div class="line">                &#123;<span class="string">'books'</span>: books, <span class="string">'query'</span>: q&#125;)</div><div class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'search_form.html'</span>,</div><div class="line">        &#123;<span class="string">'error'</span>: error&#125;)</div></pre></td></tr></table></figure></p>
<p>问题的实质在于我们只使用来一个布尔类型的变量来检测是否出错，而不是使用一个列表来记录相应的错误信息。 我们需要做如下的调整：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(request)</span>:</span></div><div class="line">    **errors = []**</div><div class="line">    <span class="keyword">if</span> <span class="string">'q'</span> <span class="keyword">in</span> request.GET:</div><div class="line">        q = request.GET[<span class="string">'q'</span>]</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> q:</div><div class="line">            **errors.append(<span class="string">'Enter a search term.'</span>)**</div><div class="line">        <span class="keyword">elif</span> len(q) &gt; <span class="number">20</span>:</div><div class="line">            **errors.append(<span class="string">'Please enter at most 20 characters.'</span>)**</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            books = Book.objects.filter(title__icontains=q)</div><div class="line">            <span class="keyword">return</span> render_to_response(<span class="string">'search_results.html'</span>,</div><div class="line">                &#123;<span class="string">'books'</span>: books, <span class="string">'query'</span>: q&#125;)</div><div class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'search_form.html'</span>,</div><div class="line">        &#123;**<span class="string">'errors'</span>: errors** &#125;)</div></pre></td></tr></table></figure></p>
<p>接着，我们要修改一下search_form.html模板，现在需要显示一个errors列表而不是一个布尔判断。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;title&gt;Search&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    **&#123;/% if errors %/&#125;**</div><div class="line">        **&lt;ul&gt;**</div><div class="line">            **&#123;/% for error in errors %/&#125;**</div><div class="line">            **&lt;li&gt;&#123;&#123; error &#125;&#125;&lt;/li&gt;**</div><div class="line">            **&#123;/% endfor %/&#125;**</div><div class="line">        **&lt;/ul&gt;**</div><div class="line">    **&#123;/% endif %/&#125;**</div><div class="line">    &lt;form action=&quot;/search/&quot; method=&quot;get&quot;&gt;</div><div class="line">        &lt;input type=&quot;text&quot; name=&quot;q&quot;&gt;</div><div class="line">        &lt;input type=&quot;submit&quot; value=&quot;Search&quot;&gt;</div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<h4 id="Contact表单（站点联系表单）"><a href="#Contact表单（站点联系表单）" class="headerlink" title="Contact表单（站点联系表单）"></a>Contact表单（站点联系表单）</h4><p>这个表单包括用户提交的反馈信息，一个可选的e-mail回信地址。 当这个表单提交并且数据通过验证后，系统将自动发送一封包含题用户提交的信息的e-mail给站点工作人员。</p>
<p>我们从contact_form.html模板入手：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;title&gt;Contact us&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;h1&gt;Contact us&lt;/h1&gt;</div><div class="line"></div><div class="line">    &#123;/% if errors %/&#125;</div><div class="line">        &lt;ul&gt;</div><div class="line">            &#123;/% for error in errors %/&#125;</div><div class="line">            &lt;li&gt;&#123;&#123; error &#125;&#125;&lt;/li&gt;</div><div class="line">            &#123;/% endfor %/&#125;</div><div class="line">        &lt;/ul&gt;</div><div class="line">    &#123;/% endif %/&#125;</div><div class="line"></div><div class="line">    &lt;form action=&quot;/contact/&quot; method=&quot;post&quot;&gt;</div><div class="line">        &lt;p&gt;Subject: &lt;input type=&quot;text&quot; name=&quot;subject&quot;&gt;&lt;/p&gt;</div><div class="line">        &lt;p&gt;Your e-mail (optional): &lt;input type=&quot;text&quot; name=&quot;email&quot;&gt;&lt;/p&gt;</div><div class="line">        &lt;p&gt;Message: &lt;textarea name=&quot;message&quot; rows=&quot;10&quot; cols=&quot;50&quot;&gt;&lt;/textarea&gt;&lt;/p&gt;</div><div class="line">        &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;</div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>我们定义了三个字段： 主题，e-mail和反馈信息。 除了e-mail字段为可选，其他两个字段都是必填项。 注意，这里我们使用method=”post”而非method=”get”，因为这个表单会有一个服务器端的操作：发送一封e-mail。 并且，我们复制了前一个模板search_form.html中错误信息显示的代码。</p>
<p>如果我们顺着上一节编写search()视图的思路，那么一个contact()视图代码应该像这样：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> send_mail</div><div class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponseRedirect</div><div class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render_to_response</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">contact</span><span class="params">(request)</span>:</span></div><div class="line">    errors = []</div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.POST.get(<span class="string">'subject'</span>, <span class="string">''</span>):</div><div class="line">            errors.append(<span class="string">'Enter a subject.'</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.POST.get(<span class="string">'message'</span>, <span class="string">''</span>):</div><div class="line">            errors.append(<span class="string">'Enter a message.'</span>)</div><div class="line">        <span class="keyword">if</span> request.POST.get(<span class="string">'email'</span>) <span class="keyword">and</span> <span class="string">'@'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.POST[<span class="string">'email'</span>]:</div><div class="line">            errors.append(<span class="string">'Enter a valid e-mail address.'</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> errors:</div><div class="line">            send_mail(</div><div class="line">                request.POST[<span class="string">'subject'</span>],</div><div class="line">                request.POST[<span class="string">'message'</span>],</div><div class="line">                request.POST.get(<span class="string">'email'</span>, <span class="string">'noreply@example.com'</span>),</div><div class="line">                [<span class="string">'siteowner@example.com'</span>],</div><div class="line">            )</div><div class="line">            <span class="keyword">return</span> HttpResponseRedirect(<span class="string">'/contact/thanks/'</span>)</div><div class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'contact_form.html'</span>,</div><div class="line">        &#123;<span class="string">'errors'</span>: errors&#125;)</div></pre></td></tr></table></figure></p>
<p>（如果按照书中的示例做下来，这这里可能乎产生一个疑问：contact()视图是否要放在books/views.py这个文件里。 但是contact()视图与books应用没有任何关联，那么这个视图应该可以放在别的地方？ 这毫无紧要，只要在URLconf里正确设置URL与视图之间的映射，Django会正确处理的。 笔者个人喜欢创建一个contact的文件夹，与books文件夹同级。这个文件夹中包括空的<strong>init</strong>.py和views.py两个文件。)</p>
<p>现在来分析一下以上代码：</p>
<p><blockquote><br>确认request.method的值是’POST’。用户浏览表单时这个值并不存在，当且仅当表单被提交时这个值才出现。 （在后面的例子中，request.method将会设置为’GET’，因为在普通的网页浏览中，浏览器都使用GET，而非POST）。判断request.method的值很好地帮助我们将表单显示与表单处理隔离开来。</blockquote></p>
<p>我们使用request.POST代替request.GET来获取提交过来的数据。 这是必须的，因为contact_form.html里表单使用的是method=”post”。如果在视图里通过POST获取数据，那么request.GET将为空。</p>
<p>这里，有两个必填项，subject 和 message，所以需要对这两个进行验证。 注意，我们使用request.POST.get()方法，并提供一个空的字符串作为默认值；这个方法很好的解决了键丢失与空数据问题。</p>
<p>虽然email非必填项，但如果有提交她的值则我们也需进行验证。 我们的验证算法相当的薄弱，仅验证值是否包含@字符。 在实际应用中，需要更为健壮的验证机制（Django提供这些验证机制，稍候我们就会看到）。</p>
<p>我们使用了django.core.mail.send_mail函数来发送e-mail。 这个函数有四个必选参数： 主题，正文，寄信人和收件人列表。 send_mail是Django的EmailMessage类的一个方便的包装，EmailMessage类提供了更高级的方法，比如附件，多部分邮件，以及对于邮件头部的完整控制。</p>
<p>注意，若要使用send_mail()函数来发送邮件，那么服务器需要配置成能够对外发送邮件，并且在Django中设置出站服务器地址。 参见规范：<a href="http://docs.djangoproject.com/en/dev/topics/email/" target="_blank" rel="external">http://docs.djangoproject.com/en/dev/topics/email/</a></p>
<p>当邮件发送成功之后，我们使用HttpResponseRedirect对象将网页重定向至一个包含成功信息的页面。 包含成功信息的页面这里留给读者去编写（很简单 一个视图/URL映射/一份模板即可），但是我们要解释一下为何重定向至新的页面，而不是在模板中直接调用render_to_response()来输出。</p>
<p>原因就是： 若用户刷新一个包含POST表单的页面，那么请求将会重新发送造成重复。 这通常会造成非期望的结果，比如说重复的数据库记录；在我们的例子中，将导致发送两封同样的邮件。 如果用户在POST表单之后被重定向至另外的页面，就不会造成重复的请求了。</p>
<p>我们应每次都给成功的POST请求做重定向。 这就是web开发的最佳实践。<br><br>contact()视图可以正常工作，但是她的验证功能有些复杂。 想象一下假如一个表单包含一打字段，我们真的将必须去编写每个域对应的if判断语句？</p>
<p>另外一个问题是表单的重新显示。若数据验证失败后，返回客户端的表单中各字段最好是填有原来提交的数据，以便用户查看哪里出现错误（用户也不需再次填写正确的字段值）。 我们可以手动地将原来的提交数据返回给模板，并且必须编辑HTML里的各字段来填充原来的值。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"># views.py</div><div class="line"></div><div class="line">def contact(request):</div><div class="line">    errors = []</div><div class="line">    if request.method == 'POST':</div><div class="line">        if not request.POST.get('subject', ''):</div><div class="line">            errors.append('Enter a subject.')</div><div class="line">        if not request.POST.get('message', ''):</div><div class="line">            errors.append('Enter a message.')</div><div class="line">        if request.POST.get('email') and '@' not in request.POST['email']:</div><div class="line">            errors.append('Enter a valid e-mail address.')</div><div class="line">        if not errors:</div><div class="line">            send_mail(</div><div class="line">                request.POST['subject'],</div><div class="line">                request.POST['message'],</div><div class="line">                request.POST.get('email', `'noreply@example.com`_'),</div><div class="line">                [`'siteowner@example.com`_'],</div><div class="line">            )</div><div class="line">            return HttpResponseRedirect('/contact/thanks/')</div><div class="line">    return render_to_response('contact_form.html', &#123;</div><div class="line">        'errors': errors,</div><div class="line">        **'subject': request.POST.get('subject', ''),**</div><div class="line">        **'message': request.POST.get('message', ''),**</div><div class="line">        **'email': request.POST.get('email', ''),**</div><div class="line">    &#125;)</div><div class="line"></div><div class="line"># contact_form.html</div><div class="line"></div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;title&gt;Contact us&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;h1&gt;Contact us&lt;/h1&gt;</div><div class="line"></div><div class="line">    &#123;/% if errors %/&#125;</div><div class="line">        &lt;ul&gt;</div><div class="line">            &#123;/% for error in errors %/&#125;</div><div class="line">            &lt;li&gt;&#123;&#123; error &#125;&#125;&lt;/li&gt;</div><div class="line">            &#123;/% endfor %/&#125;</div><div class="line">        &lt;/ul&gt;</div><div class="line">    &#123;/% endif %/&#125;</div><div class="line"></div><div class="line">    &lt;form action="/contact/" method="post"&gt;</div><div class="line">        &lt;p&gt;Subject: &lt;input type="text" name="subject" **value="&#123;&#123; subject &#125;&#125;"** &gt;&lt;/p&gt;</div><div class="line">        &lt;p&gt;Your e-mail (optional): &lt;input type="text" name="email" **value="&#123;&#123; email &#125;&#125;"** &gt;&lt;/p&gt;</div><div class="line">        &lt;p&gt;Message: &lt;textarea name="message" rows="10" cols="50"&gt;**&#123;&#123; message &#125;&#125;**&lt;/textarea&gt;&lt;/p&gt;</div><div class="line">        &lt;input type="submit" value="Submit"&gt;</div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<h3 id="Form类"><a href="#Form类" class="headerlink" title="Form类"></a>Form类</h3><p>Django带有一个form库，称为django.forms</p>
<p>Django的newforms库</p>
<p>在Django社区上会经常看到django.newforms这个词语。当人们讨论django.newforms，其实就是我们本章里面介绍的django.forms。</p>
<p>当Django 1.0发布时，旧版本django.forms就不再使用了，而django.newforms也终于可以名正言顺的叫做：django.forms。</p>
<p>这个类可以存在于任何地方，甚至直接写在<code>views.py</code> 文件里也行，但是社区的惯例是把Form类都放到一个文件中：forms.py。在存放<code>views.py</code> 的目录中，创建这个文件，然后输入：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactForm</span><span class="params">(forms.Form)</span>:</span></div><div class="line">    subject = forms.CharField()</div><div class="line">    email = forms.EmailField(required=<span class="keyword">False</span>)</div><div class="line">    message = forms.CharField()</div></pre></td></tr></table></figure></p>
<p>这看上去简单易懂，并且很像在模块中使用的语法。 表单中的每一个字段（域）作为Form类的属性，被展现成Field类。这里只用到CharField和EmailField类型。 每一个字段都默认是必填。要使email成为可选项，我们需要指定required=False。</p>
<p>它做的第一件事是将自己显示成HTML.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> contact.forms <span class="keyword">import</span> ContactForm</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f = ContactForm()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> f</div></pre></td></tr></table></figure></p>
<p>为了便于访问，Django用<code>&lt;label&gt;</code> 标志，为每一个字段添加了标签。 这个做法使默认行为尽可能合适。</p>
<p>默认输出按照HTML的&lt;<code>table</code> &gt;格式，另外有一些其它格式的输出：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> f.as_ul()</div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> f.as_p()</div></pre></td></tr></table></figure></p>
<p>请注意，标签&lt;’table’&gt;、&lt;’ul’&gt;、&lt;’form’&gt;的开闭合标记没有包含于输出当中，这样你就可以添加额外的行或者自定义格式。</p>
<p>这些类方法只是一般情况下用于快捷显示完整表单的方法。 你同样可以用HTML显示个别字段：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> f[<span class="string">'subject'</span>]</div><div class="line">&lt;input type=<span class="string">"text"</span> name=<span class="string">"subject"</span> id=<span class="string">"id_subject"</span> /&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> f[<span class="string">'message'</span>]</div><div class="line">&lt;input type=<span class="string">"text"</span> name=<span class="string">"message"</span> id=<span class="string">"id_message"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p>Form对象做的第二件事是校验数据。 为了校验数据，我们创建一个新的对Form象，并且传入一个与定义匹配的字典类型数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; f = ContactForm(&#123;&apos;subject&apos;: &apos;Hello&apos;, &apos;email&apos;: &apos;adrian@example.com&apos;, &apos;message&apos;: &apos;Nice site!&apos;&#125;)</div></pre></td></tr></table></figure></p>
<p>一旦你对一个Form实体赋值，你就得到了一个绑定form：</p>
<p>调用任何绑定form的is_valid()方法，就可以知道它的数据是否合法。 我们已经为每个字段传入了值，因此整个Form是合法的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>f.is_valid()</div><div class="line"><span class="keyword">True</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f = ContactForm(&#123;<span class="string">'subject'</span>: <span class="string">'Hello'</span>, <span class="string">'message'</span>: <span class="string">'Nice site!'</span>&#125;)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f.is_valid()</div><div class="line"><span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<p>你可以逐一查看每个字段的出错消息：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>f = ContactForm(&#123;<span class="string">'subject'</span>: <span class="string">'Hello'</span>, <span class="string">'message'</span>: <span class="string">''</span>&#125;)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f[<span class="string">'message'</span>].errors</div><div class="line">[<span class="string">u'This field is required.'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f[<span class="string">'subject'</span>].errors</div><div class="line">[]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f[<span class="string">'email'</span>].errors</div><div class="line">[]</div></pre></td></tr></table></figure></p>
<p>最终，如果一个Form实体的数据是合法的，它就会有一个可用的cleaned_data属性。 这是一个包含干净的提交数据的字典。 Django的form框架不但校验数据，它还会把它们转换成相应的Python类型数据，这叫做清理数据。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; f = ContactForm(&#123;subject': Hello, email: adrian@example.com, message: Nice site!&#125;)</div><div class="line">&gt;&gt;&gt; f.is_valid()</div><div class="line">True</div><div class="line">&gt;&gt;&gt; f.cleaned_data</div><div class="line">&#123;message': uNice site!, email: uadrian@example.com, subject: uHello&#125;</div></pre></td></tr></table></figure></p>
<p>我们的contact form只涉及字符串类型，它们会被清理成Unicode对象。如果我们使用整数型或日期型，form框架会确保方法使用合适的Python整数型或datetime.date型对象。</p>
<p>在学习了关于Form类的基本知识后，你会看到我们如何把它用到视图中，取代contact()代码中不整齐的部分。 一下示例说明了我们如何用forms框架重写contact()：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"># views.py</div><div class="line"></div><div class="line">from django.shortcuts import render_to_response</div><div class="line">from mysite.contact.forms import ContactForm</div><div class="line"></div><div class="line">def contact(request):</div><div class="line">    if request.method == 'POST':</div><div class="line">        form = ContactForm(request.POST)</div><div class="line">        if form.is_valid():</div><div class="line">            cd = form.cleaned_data</div><div class="line">            send_mail(</div><div class="line">                cd['subject'],</div><div class="line">                cd['message'],</div><div class="line">                cd.get('email', 'noreply@example.com'),</div><div class="line">                ['siteowner@example.com'],</div><div class="line">            )</div><div class="line">            return HttpResponseRedirect('/contact/thanks/')</div><div class="line">    else:</div><div class="line">        form = ContactForm()</div><div class="line">    return render_to_response('contact_form.html', &#123;'form': form&#125;)</div><div class="line"></div><div class="line"># contact_form.html</div><div class="line"></div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;title&gt;Contact us&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;h1&gt;Contact us&lt;/h1&gt;</div><div class="line"></div><div class="line">    &#123;/% if form.errors %/&#125;</div><div class="line">        &lt;p style="color: red;"&gt;</div><div class="line">            Please correct the error&#123;&#123; form.errors|pluralize &#125;&#125; below.</div><div class="line">        &lt;/p&gt;</div><div class="line">    &#123;/% endif %/&#125;</div><div class="line"></div><div class="line">    &lt;form action="" method="post"&gt;</div><div class="line">        &lt;table&gt;</div><div class="line">            &#123;&#123; form.as_table &#125;&#125;</div><div class="line">        &lt;/table&gt;</div><div class="line">        &lt;input type="submit" value="Submit"&gt;</div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<h4 id="csrf错误"><a href="#csrf错误" class="headerlink" title="csrf错误"></a>csrf错误</h4><p><strong>注意</strong>此处如果按照原文作会出现<strong>crsf</strong>错误：<br><img src="https://i.gyazo.com/84efb691ea98375efb7673559b069507.png" alt=""></p>
<p>解决方法：</p>
<ol>
<li>添加 views.py render_to_response(context_instance=RequestContext(request))</li>
<li>添加 contact_forms.html <form>{/% csrf_token %/}</form></li>
</ol>
<h4 id="forms表单进阶"><a href="#forms表单进阶" class="headerlink" title="forms表单进阶"></a>forms表单进阶</h4><p>你可能首先注意到：当你在本地显示这个表单的时，message字段被显示成<code>input type=”text”</code> ，而它应该被显示成&lt;<code>textarea</code> &gt;。我们可以通过设置<em> widget</em> 来修改它：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactForm</span><span class="params">(forms.Form)</span>:</span></div><div class="line">    subject = forms.CharField()</div><div class="line">    email = forms.EmailField(required=<span class="keyword">False</span>)</div><div class="line">    message = forms.CharField(**widget=forms.Textarea** )</div></pre></td></tr></table></figure></p>
<p>forms框架把每一个字段的显示逻辑分离到一组部件（widget）中。 每一个字段类型都拥有一个默认的部件，我们也可以容易地替换掉默认的部件，或者提供一个自定义的部件。</p>
<p>考虑一下Field类表现<em> 校验逻辑</em> ，而部件表现<em> 显示逻辑</em> 。</p>
<p>一个最经常使用的校验要求是检查字段长度。 另外，我们应该改进ContactForm，使subject限制在100个字符以内。 为此，仅需为CharField提供max_length参数，像这样：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactForm</span><span class="params">(forms.Form)</span>:</span></div><div class="line">    subject = forms.CharField(**max_length=<span class="number">100</span>** )</div><div class="line">    email = forms.EmailField(required=<span class="keyword">False</span>)</div><div class="line">    message = forms.CharField(widget=forms.Textarea)</div></pre></td></tr></table></figure></p>
<p>选项min_length参数同样可用。</p>
<p>让我们再改进一下这个表单：为字subject段添加<em> 初始值</em> ： “I love your site!” （一点建议，但没坏处。）为此，我们可以在创建Form实体时，使用initial参数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">contact</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        form = ContactForm(request.POST)</div><div class="line">        <span class="keyword">if</span> form.is_valid():</div><div class="line">            cd = form.cleaned_data</div><div class="line">            send_mail(</div><div class="line">                cd[<span class="string">'subject'</span>],</div><div class="line">                cd[<span class="string">'message'</span>],</div><div class="line">                cd.get(<span class="string">'email'</span>, `<span class="string">'noreply@example.com`_'</span>),</div><div class="line">                [`<span class="string">'siteowner@example.com`_'</span>],</div><div class="line">            )</div><div class="line">            <span class="keyword">return</span> HttpResponseRedirect(<span class="string">'/contact/thanks/'</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        form = ContactForm(</div><div class="line">            **initial=&#123;<span class="string">'subject'</span>: <span class="string">'I love your site!'</span>&#125;**</div><div class="line">        )</div><div class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'contact_form.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</div></pre></td></tr></table></figure></p>
<p>请注意，传入<em> 初始值</em> 数据和传入数据以<em> 绑定</em> 表单是有区别的。 最大的区别是，如果仅传入<em> 初始值</em> 数据，表单是unbound的，那意味着它没有错误消息。</p>
<p>我们有很多的方法把我们的自定义校验挂在Django的form上。 如果我们的规则会被一次又一次的使用，我们可以创建一个自定义的字段类型。 大多数的自定义校验都是一次性的，可以直接绑定到form类.</p>
<p>我们希望<code>message</code> 字段有一个额外的校验，我们增加一个<code>clean_message()</code> 方法到<code>Form</code> 类：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactForm</span><span class="params">(forms.Form)</span>:</span></div><div class="line">    subject = forms.CharField(max_length=<span class="number">100</span>)</div><div class="line">    email = forms.EmailField(required=<span class="keyword">False</span>)</div><div class="line">    message = forms.CharField(widget=forms.Textarea)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_message</span><span class="params">(self)</span>:</span></div><div class="line">        message = self.cleaned_data[<span class="string">'message'</span>]</div><div class="line">        num_words = len(message.split())</div><div class="line">        <span class="keyword">if</span> num_words &lt; <span class="number">4</span>:</div><div class="line">            <span class="keyword">raise</span> forms.ValidationError(<span class="string">"Not enough words!"</span>)</div><div class="line">        <span class="keyword">return</span> message</div></pre></td></tr></table></figure></p>
<p>Django的form系统自动寻找匹配的函数方法，该方法名称以clean_开头，并以字段名称结束。 如果有这样的方法，它将在校验时被调用。</p>
<p>我们简单地使用了len()和split()的组合来计算单词的数量。 如果用户输入字数不足，我们抛出一个forms.ValidationError型异常。这个异常的描述会被作为错误列表中的一项显示给用户。</p>
<p>在函数的末尾显式地返回字段的值非常重要。 我们可以在我们自定义的校验方法中修改它的值（或者把它转换成另一种Python类型）。 如果我们忘记了这一步，None值就会返回，原始的数据就丢失掉了。</p>
<p>像在模块中做过的那样，我们同样可以自定义字段的标签。 仅需使用label，像这样：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactForm</span><span class="params">(forms.Form)</span>:</span></div><div class="line">    subject = forms.CharField(max_length=<span class="number">100</span>)</div><div class="line">    email = forms.EmailField(required=<span class="keyword">False</span>, **label=<span class="string">'Your e-mail address'</span>** )</div><div class="line">    message = forms.CharField(widget=forms.Textarea)</div></pre></td></tr></table></figure></p>
<p>在上面的<code>contact_form.html</code> 模板中我们使用<code></code> 显示表单，不过我们可以使用其他更精确控制表单显示的方法。</p>
<p>修改form的显示的最快捷的方式是使用CSS。 尤其是错误列表，可以增强视觉效果。自动生成的错误列表精确的使用<code>&lt;ul class=”errorlist”&gt;</code>，这样，我们就可以针对它们使用CSS。 下面的CSS让错误更加醒目了：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;style type="text/css"&gt;</div><div class="line">    ul.errorlist &#123;</div><div class="line">        margin: 0;</div><div class="line">        padding: 0;</div><div class="line">    &#125;</div><div class="line">    .errorlist li &#123;</div><div class="line">        background-color: red;</div><div class="line">        color: white;</div><div class="line">        display: block;</div><div class="line">        font-size: 10px;</div><div class="line">        margin: 0 0 3px;</div><div class="line">        padding: 4px 5px;</div><div class="line">    &#125;</div><div class="line">&lt;/style&gt;</div></pre></td></tr></table></figure></p>
<p>虽然，自动生成HTML是很方便的，但是在某些时候，你会想覆盖默认的显示。 和其它的方法在开发的时候是一个快捷的方式，form的显示方式也可以在form中被方便地重写。</p>
<p>每一个字段部件(&lt;’input type=”text”’&gt;, &lt;’select’&gt;, &lt;’textarea’&gt;, 或者类似)都可以通过访问进行单独的渲染。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Contact us<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Contact us<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line"></div><div class="line">    &#123;/% if form.errors %/&#125;</div><div class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">"color: red;"</span>&gt;</span></div><div class="line">            Please correct the error&#123;&#123; form.errors|pluralize &#125;&#125; below.</div><div class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">    &#123;/% endif %/&#125;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            &#123;&#123; form.subject.errors &#125;&#125;</div><div class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"id_subject"</span>&gt;</span>Subject:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">            &#123;&#123; form.subject &#125;&#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            &#123;&#123; form.email.errors &#125;&#125;</div><div class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"id_email"</span>&gt;</span>Your e-mail address:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">            &#123;&#123; form.email &#125;&#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"field"</span>&gt;</span></div><div class="line">            &#123;&#123; form.message.errors &#125;&#125;</div><div class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"id_message"</span>&gt;</span>Message:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">            &#123;&#123; form.message &#125;&#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<hr>
<h3 id="声明："><a href="#声明：" class="headerlink" title="声明："></a>声明：</h3><p><strong> 欢迎转载，转载时请注明出处，请尊重知识和劳动！</strong></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/Django-Web框架摘要-三/2016/11/13/" rel="next" title="Django Web框架摘要(三)">
                <i class="fa fa-chevron-left"></i> Django Web框架摘要(三)
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="Django-Web框架摘要-四/2016/11/21/"
     data-title="Django-Web框架摘要(四)"
     data-content=""
     data-url="http://yoursite.com/Django-Web框架摘要-四/2016/11/21/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="Django-Web框架摘要-四/2016/11/21/"
           data-title="Django-Web框架摘要(四)" data-url="http://yoursite.com/Django-Web框架摘要-四/2016/11/21/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="JacobYRJ" />
          <p class="site-author-name" itemprop="name">JacobYRJ</p>
          <p class="site-description motion-element" itemprop="description">fighting!fighting!fighting!</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">10</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/JacobYRJ" target="_blank" title="github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  github
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#站点管理"><span class="nav-number">1.</span> <span class="nav-text">站点管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#django-contrib包"><span class="nav-number">1.1.</span> <span class="nav-text">django.contrib包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#激活管理界面"><span class="nav-number">1.2.</span> <span class="nav-text">激活管理界面</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Models加到Admin管理中"><span class="nav-number">1.3.</span> <span class="nav-text">Models加到Admin管理中</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Admin工作原理"><span class="nav-number">2.</span> <span class="nav-text">Admin工作原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#字段设置"><span class="nav-number">2.1.</span> <span class="nav-text">字段设置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义ModelAdmi类（data列表操作）"><span class="nav-number">3.</span> <span class="nav-text">自定义ModelAdmi类（data列表操作）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义列表"><span class="nav-number">3.1.</span> <span class="nav-text">自定义列表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">3.2.</span> <span class="nav-text">自定义编辑表单</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">用户权限及管理界面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">表单view.py</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">5.1.</span> <span class="nav-text">URL相关信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">5.2.</span> <span class="nav-text">request其他信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">5.3.</span> <span class="nav-text">resquest.POST和resquest.GET</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#改进表单"><span class="nav-number">5.4.</span> <span class="nav-text">改进表单</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Contact表单（站点联系表单）"><span class="nav-number">5.5.</span> <span class="nav-text">Contact表单（站点联系表单）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Form类"><span class="nav-number">6.</span> <span class="nav-text">Form类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#csrf错误"><span class="nav-number">6.1.</span> <span class="nav-text">csrf错误</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#forms表单进阶"><span class="nav-number">6.2.</span> <span class="nav-text">forms表单进阶</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明："><span class="nav-number">7.</span> <span class="nav-text">声明：</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JacobYRJ</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/VEN/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/VEN/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/VEN/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/VEN/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/VEN/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/VEN/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"JacobYRJ"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/VEN/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("n9eXnIy0IFoUCLrw6D0SgPa2-gzGzoHsz", "SQWCDRNfKamzvkE0z5WSqqkr");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
